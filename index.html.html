<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Obra - Cedro Residence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></link>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-4xl mx-auto p-4">

        <!-- CABEÇALHO -->
        <header class="bg-white shadow-md rounded-lg p-4 mb-6 flex justify-between items-center">
            <div>
                <h1 id="header-title" class="text-2xl font-bold text-gray-700">Cedro Residence</h1>
                <p id="header-subtitle" class="text-sm text-gray-500">Visão Geral dos Blocos</p>
            </div>
            <button id="back-button" class="hidden bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition">
                <i class="fas fa-arrow-left mr-2"></i>Voltar
            </button>
        </header>

        <!-- TELA DE CARREGAMENTO -->
        <div id="loading-view" class="text-center py-20 active">
            <div class="loader mx-auto"></div>
            <p class="mt-4 text-gray-600">Conectando ao banco de dados...</p>
        </div>
        
        <!-- TELAS DA APLICAÇÃO -->
        <div id="blocks-view" class="view">
            <div id="blocks-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
        </div>
        <div id="floors-view" class="view">
            <div id="floors-list" class="space-y-4"></div>
        </div>
        <div id="apartments-view" class="view">
            <div id="apartments-list" class="space-y-4"></div>
        </div>
        <div id="services-view" class="view">
            <div id="services-list" class="bg-white rounded-lg shadow-md"></div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="status-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 w-11/12 max-w-sm">
            <h3 class="text-lg font-bold mb-4">Alterar Status e Adicionar Observação</h3>
            <div class="mb-4">
                <label for="observation-text" class="block text-sm font-medium text-gray-700 mb-1">Observação:</label>
                <textarea id="observation-text" rows="3" class="w-full border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
            <h4 class="text-md font-semibold mb-2 text-gray-800">Selecione o novo status:</h4>
            <div id="status-options" class="space-y-2"></div>
            <div class="mt-6 flex justify-end">
                <button id="close-modal-button" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ====================================================================================
        // PASSO IMPORTANTE: COLE A SUA CONFIGURAÇÃO DO FIREBASE AQUI
        // Siga o guia para obter este bloco de código no site da Firebase.
        // ====================================================================================
       const firebaseConfig = {
    apiKey: "AIzaSyASWl8Udr7QcBY0E5WntklKtiGTK86HcF",
    authDomain: "controle-de-obra-cedro.firebaseapp.com",
    projectId: "controle-de-obra-cedro",
    storageBucket: "controle-de-obra-cedro.appspot.com",
    messagingSenderId: "413066555990",
    appId: "1:413066555990:web:8d1c61f9a0c3cb12281f7",
    measurementId: "G-8H7HNDS3F5"
};
        // ====================================================================================

        const loadingView = document.getElementById('loading-view');

        if (firebaseConfig.apiKey === "COLE_AQUI_SUA_API_KEY") {
            loadingView.innerHTML = '<p class="text-red-500 font-bold p-4 text-center">Configuração Pendente: É necessário inserir suas credenciais do Firebase no arquivo HTML para o aplicativo funcionar.</p>';
            throw new Error("Firebase config not found");
        }
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId;

        // --- ESTRUTURA DE DADOS E CONFIGURAÇÕES ---
        const TOTAL_BLOCKS = 28;
        const APARTMENTS_PER_FLOOR = 4;
        const HALL_ID = 'apto-hall';
        const floors = ["Pav. Térreo", "Pav. 1", "Pav. 2", "Pav. 3"];
        const services = [
            "01-Fundação", "02-Forma e limpeza", "03-Lixamento de parede de concreto", "04-Graute da linha de vida",
            "05-Retrabalhos", "06-Aereo", "07-Isometrico", "08-Ramal do hall", "09-Chumbamento e grauteamento",
            "10-Cobertura", "11-Alvenaria do hall", "12-Assentamento do Combogo", "13-Execução do Contrapiso",
            "14-Assentamento do peitoril", "15-Assentamento da Esquadrias", "16-Tratamento externo",
            "17-Assentamento do shaft", "18-Enfiação, disjuntores", "19-Impermeabilização",
            "20-Sanca, forro, shaft, arestamento", "21-Gesso Corrido", "22-Cerâmica",
            "23-Kit porta e Alizar", "24-Pintura"
        ];
        const statusConfig = {
            'Não Iniciado': { color: 'bg-gray-200', text: 'text-gray-800', icon: 'fa-circle-notch' },
            'Em Andamento': { color: 'bg-yellow-400', text: 'text-white', icon: 'fa-person-digging' },
            'Concluído': { color: 'bg-green-500', text: 'text-white', icon: 'fa-check-circle' },
            'Liberado c/ Pendência': { color: 'bg-orange-400', text: 'text-white', icon: 'fa-exclamation-triangle' },
            'Reprovado': { color: 'bg-red-500', text: 'text-white', icon: 'fa-times-circle' },
        };
        const statusOptions = Object.keys(statusConfig);
        let currentData = {};
        let currentBlockId = null;
        let currentFloorId = null;
        let currentApartmentId = null;
        let currentServiceId = null;

        const getApartmentName = (floorIndex, aptId) => {
            if (aptId === HALL_ID) return 'HALL';
            const aptIndex = parseInt(aptId.split('-')[1]);
            const aptNumber = aptIndex + 1;
            return floorIndex === 0 ? `Apto ${String(aptNumber).padStart(2, '0')}` : `Apto ${floorIndex}0${aptNumber}`;
        };

        const navigate = (viewId) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            const backButton = document.getElementById('back-button');
            const headerTitle = document.getElementById('header-title');
            const headerSubtitle = document.getElementById('header-subtitle');
            const blockName = currentBlockId ? `Bloco ${currentBlockId.split('-')[1].padStart(2, '0')}` : "Cedro Residence";
            headerTitle.innerText = blockName;

            if (viewId === 'blocks-view') {
                backButton.classList.add('hidden');
                headerTitle.innerText = "Cedro Residence";
                headerSubtitle.innerText = "Visão Geral dos Blocos";
            } else {
                backButton.classList.remove('hidden');
                const floorIndex = currentFloorId ? parseInt(currentFloorId.split('-')[1]) : -1;
                const floorName = floorIndex !== -1 ? floors[floorIndex] : '';
                if (viewId === 'floors-view') headerSubtitle.innerText = "Visão dos Pavimentos";
                else if (viewId === 'apartments-view') headerSubtitle.innerText = `${floorName} - Apartamentos e Hall`;
                else if (viewId === 'services-view') {
                     const aptName = getApartmentName(floorIndex, currentApartmentId);
                     headerSubtitle.innerText = `${floorName} - ${aptName}`;
                }
            }
        };

        const renderBlocks = () => {
            const grid = document.getElementById('blocks-grid');
            grid.innerHTML = '';
            const sortedBlockIds = Object.keys(currentData).sort((a, b) => parseInt(a.split('-')[1]) - parseInt(b.split('-')[1]));
            sortedBlockIds.forEach(blockId => {
                const blockData = currentData[blockId];
                if (!blockData) return;
                const i = blockId.split('-')[1];
                let totalServices = 0, completedServices = 0;
                Object.values(blockData).forEach(floor => {
                    Object.values(floor).forEach(apartment => {
                        totalServices += services.length;
                        Object.values(apartment).forEach(service => {
                            if (service.status === 'Concluído' || service.status === 'Liberado c/ Pendência') completedServices++;
                        });
                    });
                });
                const progress = totalServices > 0 ? (completedServices / totalServices) * 100 : 0;
                const blockEl = document.createElement('div');
                blockEl.className = 'bg-white p-4 rounded-lg shadow-md flex flex-col justify-between cursor-pointer hover:shadow-xl transition';
                blockEl.innerHTML = `<h3 class="font-bold text-lg text-gray-700">Bloco ${String(i).padStart(2, '0')}</h3><div class="mt-2"><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%"></div></div><p class="text-xs text-right mt-1 text-gray-500">${Math.round(progress)}%</p></div>`;
                blockEl.onclick = () => { currentBlockId = blockId; renderFloors(); navigate('floors-view'); };
                grid.appendChild(blockEl);
            });
        };

        const renderFloors = () => {
            const list = document.getElementById('floors-list');
            list.innerHTML = '';
            const blockData = currentData[currentBlockId];
            floors.forEach((floorName, index) => {
                const floorId = `pav-${index}`;
                const floorData = blockData[floorId];
                let totalServices = 0, completedServices = 0;
                if (floorData) {
                    Object.values(floorData).forEach(apartment => {
                        totalServices += services.length;
                        completedServices += Object.values(apartment).filter(s => s.status === 'Concluído' || s.status === 'Liberado c/ Pendência').length;
                    });
                }
                const progress = totalServices > 0 ? (completedServices / totalServices) * 100 : 0;
                const floorEl = document.createElement('div');
                floorEl.className = 'bg-white p-4 rounded-lg shadow-md cursor-pointer hover:shadow-lg transition';
                floorEl.innerHTML = `<div class="flex justify-between items-center"><h3 class="font-bold text-lg text-gray-700">${floorName}</h3><span class="text-gray-600">${Math.round(progress)}%</span></div><div class="w-full bg-gray-200 rounded-full h-2.5 mt-2"><div class="bg-green-600 h-2.5 rounded-full" style="width: ${progress}%"></div></div>`;
                floorEl.onclick = () => { currentFloorId = floorId; renderApartments(); navigate('apartments-view'); };
                list.appendChild(floorEl);
            });
        };

        const renderApartments = () => {
            const list = document.getElementById('apartments-list');
            list.innerHTML = '';
            const floorData = currentData[currentBlockId][currentFloorId];
            const floorIndex = parseInt(currentFloorId.split('-')[1]);
            for (let i = 0; i < APARTMENTS_PER_FLOOR; i++) renderApartmentOrHallCard(list, floorData, floorIndex, `apto-${i}`);
            renderApartmentOrHallCard(list, floorData, floorIndex, HALL_ID);
        };

        const renderApartmentOrHallCard = (list, floorData, floorIndex, aptId) => {
            const aptData = floorData[aptId];
            if (!aptData) return;
            const aptName = getApartmentName(floorIndex, aptId);
            let completedServices = Object.values(aptData).filter(s => s.status === 'Concluído' || s.status === 'Liberado c/ Pendência').length;
            const progress = services.length > 0 ? (completedServices / services.length) * 100 : 0;
            const isHall = aptId === HALL_ID;
            const aptEl = document.createElement('div');
            aptEl.className = `${isHall ? 'bg-indigo-50' : 'bg-white'} p-4 rounded-lg shadow-md cursor-pointer hover:shadow-lg transition`;
            aptEl.innerHTML = `<div class="flex justify-between items-center"><h3 class="font-bold text-lg text-gray-700">${aptName}</h3><span class="text-gray-600">${Math.round(progress)}%</span></div><div class="w-full bg-gray-200 rounded-full h-2.5 mt-2"><div class="${isHall ? 'bg-indigo-600' : 'bg-purple-600'} h-2.5 rounded-full" style="width: ${progress}%"></div></div>`;
            aptEl.onclick = () => { currentApartmentId = aptId; renderServices(); navigate('services-view'); };
            list.appendChild(aptEl);
        };

        const renderServices = () => {
            const list = document.getElementById('services-list');
            list.innerHTML = '';
            const aptData = currentData[currentBlockId][currentFloorId][currentApartmentId];
            services.forEach((serviceName, index) => {
                const serviceId = `serv-${index}`;
                const serviceData = aptData[serviceId];
                const config = statusConfig[serviceData.status];
                const noteIcon = serviceData.notes ? `<i class="fas fa-comment-dots text-gray-400 ml-2"></i>` : '';
                const serviceEl = document.createElement('div');
                serviceEl.className = 'flex items-center justify-between p-4 border-b border-gray-200 cursor-pointer hover:bg-gray-50';
                serviceEl.innerHTML = `<div class="flex items-center flex-grow text-gray-700 mr-4"><span>${serviceName}</span>${noteIcon}</div><div class="${config.color} ${config.text} text-xs font-semibold px-3 py-1 rounded-full flex items-center flex-shrink-0"><i class="fas ${config.icon} mr-2"></i><span>${serviceData.status}</span></div>`;
                serviceEl.onclick = () => { currentServiceId = serviceId; openStatusModal(); };
                list.appendChild(serviceEl);
            });
        };
        
        const openStatusModal = () => {
            const modal = document.getElementById('status-modal');
            const optionsContainer = document.getElementById('status-options');
            const observationText = document.getElementById('observation-text');
            optionsContainer.innerHTML = '';
            const serviceData = currentData[currentBlockId][currentFloorId][currentApartmentId][currentServiceId];
            observationText.value = serviceData.notes || '';
            statusOptions.forEach(status => {
                const config = statusConfig[status];
                const optionEl = document.createElement('button');
                optionEl.className = `w-full text-left p-3 rounded-lg flex items-center transition ${config.color} ${config.text}`;
                if (status === serviceData.status) optionEl.classList.add('ring-2', 'ring-blue-500', 'ring-offset-2');
                optionEl.innerHTML = `<i class="fas ${config.icon} mr-3"></i><span>${status}</span>`;
                optionEl.onclick = () => updateService(status);
                optionsContainer.appendChild(optionEl);
            });
            modal.classList.remove('hidden');
        };
        
        const closeModal = () => document.getElementById('status-modal').classList.add('hidden');

        const updateService = async (newStatus) => {
            try {
                const observationText = document.getElementById('observation-text').value;
                currentData[currentBlockId][currentFloorId][currentApartmentId][currentServiceId].status = newStatus;
                currentData[currentBlockId][currentFloorId][currentApartmentId][currentServiceId].notes = observationText;
                const docRef = doc(db, 'users', userId, 'obra-cedro-residence', currentBlockId);
                await setDoc(docRef, currentData[currentBlockId]);
                closeModal();
                renderServices();
                if (document.getElementById('apartments-view').classList.contains('active')) renderApartments();
            } catch (error) {
                console.error("Erro ao atualizar serviço: ", error);
                alert("Não foi possível atualizar o serviço. Verifique sua conexão com a internet.");
            }
        };

        const initializeDataStructure = () => {
            const initialData = {};
            for (let i = 1; i <= TOTAL_BLOCKS; i++) {
                const blockId = `bloco-${i}`;
                initialData[blockId] = {};
                floors.forEach((_, floorIndex) => {
                    const floorId = `pav-${floorIndex}`;
                    initialData[blockId][floorId] = {};
                    for (let j = 0; j < APARTMENTS_PER_FLOOR; j++) {
                        const aptId = `apto-${j}`;
                        initialData[blockId][floorId][aptId] = {};
                        services.forEach((_, serviceIndex) => {
                            initialData[blockId][floorId][aptId][`serv-${serviceIndex}`] = { status: 'Não Iniciado', notes: '' };
                        });
                    }
                    initialData[blockId][floorId][HALL_ID] = {};
                    services.forEach((_, serviceIndex) => {
                        initialData[blockId][floorId][HALL_ID][`serv-${serviceIndex}`] = { status: 'Não Iniciado', notes: '' };
                    });
                });
            }
            return initialData;
        };

        const loadData = async () => {
            loadingView.innerHTML = `<div class="loader mx-auto"></div><p class="mt-4 text-gray-600">Carregando dados da obra...</p>`;
            try {
                const batch = writeBatch(db);
                const initialStructure = initializeDataStructure();
                let needsSetup = false;
                for (let i = 1; i <= TOTAL_BLOCKS; i++) {
                    const blockId = `bloco-${i}`;
                    const docRef = doc(db, 'users', userId, 'obra-cedro-residence', blockId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        currentData[blockId] = docSnap.data();
                    } else {
                        needsSetup = true;
                        batch.set(docRef, initialStructure[blockId]);
                        currentData[blockId] = initialStructure[blockId];
                    }
                }
                if (needsSetup) await batch.commit();
                renderBlocks();
                navigate('blocks-view');
            } catch (e) {
                console.error("Erro ao carregar ou inicializar dados: ", e);
                alert("ERRO: Não foi possível carregar os dados. Verifique sua conexão com a internet e recarregue a página.");
            } finally {
                loadingView.classList.remove('active');
                document.getElementById('blocks-view').classList.add('active');
            }
        };

        document.getElementById('back-button').addEventListener('click', () => {
            if (document.getElementById('services-view').classList.contains('active')) navigate('apartments-view');
            else if (document.getElementById('apartments-view').classList.contains('active')) navigate('floors-view');
            else if (document.getElementById('floors-view').classList.contains('active')) navigate('blocks-view');
        });
        document.getElementById('close-modal-button').addEventListener('click', closeModal);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                await loadData();
            } else {
                signInAnonymously(auth).catch(error => {
                     console.error("Erro ao tentar login anônimo: ", error);
                     loadingView.innerHTML = `<p class="text-red-500 font-bold">Erro de Autenticação. Não foi possível conectar ao serviço.</p>`;
                });
            }
        });
    </script>
</body>
</html>
